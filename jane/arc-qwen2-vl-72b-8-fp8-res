Processing:
  Image : ../accuracy/invoice/Apple-Stock-Price.png
  Prompt: ../accuracy/invoice/prompt.txt

Namespace(seed=0, batch_size=1, output_len=512, image_path='../accuracy/invoice/Apple-Stock-Price.png', prompt='请详细描述图像内容', model='/llm/models/Qwen2-VL-72B-Instruct/', base_url=None, host='127.0.0.1', port=8000, endpoint='/v1/chat/completions', served_model_name=None, ignore_eos=False)
image size:  (1814, 1001)
输出结果： 这张图片显示了苹果公司（AAPL）的股票信息和图表。以下是详细描述：

### 股票信息
- **当前价格**: 202.14美元
- **涨跌情况**: -0.38美元 (-0.19%)
- **前收盘价**: 202.52美元
- **开盘价**: 201.85美元
- **日内波动范围**: 199.82 - 203.51美元
- **52周波动范围**: 164.08 - 260.10美元
- **成交量**: 50,304,417股
- **平均成交量**: 62,705,940股

### 市场数据
- **市值**: 3.037万亿美元
- **贝塔值 (5年月度)**: 1.26
- **市盈率 (TTM)**: 32.03
- **每股收益 (TTM)**: 6.31美元
- **派息日期**: 2025年5月1日
- **预期派息日期**: 2025年2月10日
- **一年目标价**: 237.39美元

### 图表信息
- **时间范围**: 5天
- **图表类型**: 关键事件图
- **图表显示**: 显示了过去5天内苹果公司的股价走势，包括几个关键事件点。

### 其他信息
- **广告**: 右上角有一个E*TRADE的广告，提示“现在是买入AAPL的好时机”。

总体来看，这张图片提供了苹果公司股票的详细市场数据和近期价格走势。
============ Serving Benchmark Result ============
Successful requests:                     1         
Benchmark duration (s):                  48.68     
Total input tokens:                      5         
Total image and input tokens:            2366      
Total generated tokens:                  392       
Request throughput (req/s):              0.02      
Output token throughput (tok/s):         8.05      
Total Token throughput (tok/s):          8.15      
---------------Time to First Token----------------
Mean TTFT (ms):                          6103.08   
Median TTFT (ms):                        6103.08   
P99 TTFT (ms):                           6103.08   
-----Time per Output Token (excl. 1st token)------
Mean TPOT (ms):                          108.90    
Median TPOT (ms):                        108.90    
P99 TPOT (ms):                           108.90    
---------------Inter-token Latency----------------
Mean ITL (ms):                           108.63    
Median ITL (ms):                         108.60    
P99 ITL (ms):                            117.21    
==================================================
Processing:
  Image : ../accuracy/invoice/Invoice-Tianjin.png
  Prompt: ../accuracy/invoice/prompt.txt

Namespace(seed=0, batch_size=1, output_len=512, image_path='../accuracy/invoice/Invoice-Tianjin.png', prompt='请详细描述图像内容', model='/llm/models/Qwen2-VL-72B-Instruct/', base_url=None, host='127.0.0.1', port=8000, endpoint='/v1/chat/completions', served_model_name=None, ignore_eos=False)
image size:  (980, 575)
输出结果： 这是一张天津增值税电子普通发票的图片。以下是发票的详细信息：

### 发票抬头
- **发票代码**: 012001800311
- **发票号码**: 3320765
- **开票日期**: 2019年05月08日
- **校验码**: 76939 05688 34666 77916

### 购买方信息
- **名称**: 个人
- **纳税人识别号**: 
- **地址、电话**: 
- **开户行及账号**: 

### 销售方信息
- **名称**: 天津瑞佳讯贸易有限公司
- **纳税人识别号**: 91120222079642398Y
- **地址、电话**: 天津市武清区京津电子商务产业园宏达道北侧2号 57807000
- **开户行及账号**: 中国建设银行股份有限公司天津武清区支行 1200172080052531259

### 商品或服务信息
- **货物或应税劳务、服务名称**: 详见销货清单
- **规格型号**: 
- **单位**: 
- **数量**: 
- **单价**: 
- **金额**: ¥46.62
- **税率**: 13%
- **税额**: ¥6.08

### 合计金额
- **价税合计（大写）**: 伍拾贰圆柒角
- **小写**: ¥52.70

### 其他信息
- **收款人**: 京东商城
- **复核**: 
- **开票人**: 京东商城
- **销售方（章）**: 天津瑞佳讯贸易有限公司发票专用章

### 验证信息
- **机器编号**: 661619942171
- **密码区**: *7//048893934//-649-<580>53+227268<07//400<<3->>>0*8+6-+-4<0885C+74-<
============ Serving Benchmark Result ============
Successful requests:                     1         
Benchmark duration (s):                  56.50     
Total input tokens:                      5         
Total image and input tokens:            761       
Total generated tokens:                  512       
Request throughput (req/s):              0.02      
Output token throughput (tok/s):         9.06      
Total Token throughput (tok/s):          9.15      
---------------Time to First Token----------------
Mean TTFT (ms):                          1769.16   
Median TTFT (ms):                        1769.16   
P99 TTFT (ms):                           1769.16   
-----Time per Output Token (excl. 1st token)------
Mean TPOT (ms):                          107.11    
Median TPOT (ms):                        107.11    
P99 TPOT (ms):                           107.11    
---------------Inter-token Latency----------------
Mean ITL (ms):                           106.90    
Median ITL (ms):                         106.92    
P99 ITL (ms):                            114.29    
==================================================
Processing:
  Image : ../accuracy/invoice/Invoice-Baidu.png
  Prompt: ../accuracy/invoice/prompt.txt

Namespace(seed=0, batch_size=1, output_len=512, image_path='../accuracy/invoice/Invoice-Baidu.png', prompt='请详细描述图像内容', model='/llm/models/Qwen2-VL-72B-Instruct/', base_url=None, host='127.0.0.1', port=8000, endpoint='/v1/chat/completions', served_model_name=None, ignore_eos=False)
image size:  (2408, 1716)
输出结果： 这是一张上海增值税专用发票的图片。以下是发票的主要内容：

### 发票抬头
- **购买方**：
  - 名称：百度时代网络技术（北京）有限公司
  - 纳税人识别号：110108787751579
  - 地址、电话：北京市海淀区东北旺西路8号中关村软件园17号楼二层A2，010-59108001
  - 开户行及账号：招商银行北京分行大屯路支行，866182028510003

### 货物或应税劳务、服务名称
- **信息费服务费**
- 数量：1
- 单价：94339.62元
- 税率：6%
- 税额：5660.38元

### 销售方
- **名称**：上海易火广告传媒有限公司
- **纳税人识别号**：913101140659591751
- **地址、电话**：嘉定区胜辛南路500号15幢1161室，55033753
- **开户行及账号**：中国银行南翔支行，446863841354

### 其他信息
- **开票日期**：2016年06月02日
- **发票号码**：14641426
- **发票代码**：3100153130
- **价税合计（小写）**：¥94339.62
- **价税合计（大写）**：玖拾肆万叁仟叁佰玖拾陆元贰角

### 印章
- 发票上盖有“上海易火广告传媒有限公司”的发票专用章。

这张发票记录了百度时代网络技术（北京）有限公司向上海易火广告传媒有限公司购买信息服务费的交易详情。
============ Serving Benchmark Result ============
Successful requests:                     1         
Benchmark duration (s):                  66.11     
Total input tokens:                      5         
Total image and input tokens:            5272      
Total generated tokens:                  462       
Request throughput (req/s):              0.02      
Output token throughput (tok/s):         6.99      
Total Token throughput (tok/s):          7.06      
---------------Time to First Token----------------
Mean TTFT (ms):                          16430.89  
Median TTFT (ms):                        16430.89  
P99 TTFT (ms):                           16430.89  
-----Time per Output Token (excl. 1st token)------
Mean TPOT (ms):                          107.76    
Median TPOT (ms):                        107.76    
P99 TPOT (ms):                           107.76    
---------------Inter-token Latency----------------
Mean ITL (ms):                           107.53    
Median ITL (ms):                         107.19    
P99 ITL (ms):                            116.27    
==================================================
Processing:
  Image : ../accuracy/invoice/Tencent-2023-Report.jpg
  Prompt: ../accuracy/invoice/prompt.txt

Namespace(seed=0, batch_size=1, output_len=512, image_path='../accuracy/invoice/Tencent-2023-Report.jpg', prompt='请详细描述图像内容', model='/llm/models/Qwen2-VL-72B-Instruct/', base_url=None, host='127.0.0.1', port=8000, endpoint='/v1/chat/completions', served_model_name=None, ignore_eos=False)
image size:  (800, 1200)
输出结果： 这张图片是腾讯2023年度财报的总结，主要分为四个部分：V型复苏，高质增长；多点业务，全面开花；海外业务，再创新高；科技投入，成效显著。

1. **V型复苏，高质增长**
   - 2023年Q4净利润同比增长44%，毛利同比增长25%，营业收入同比增长7%。
   - 金融科技及企业服务板块收入2038亿元，占总营收的33.5%，连续两年营收贡献第一。

2. **多点业务，全面开花**
   - 微信及WeChat月活增至13.4亿。
   - 视频号用户使用时长年比增长翻倍，Q4产生收入的创作者同比增长两倍多。
   - 小游戏流水年增长超50%。
   - 微信搜索日活用户数破1亿。
   - 腾讯视频付费用户再破1.17亿。
   - 腾讯音乐订阅用户达1.07亿。

3. **海外业务，再创新高**
   - 国际游戏业务年收入532亿，占总游戏收入的30%。
   - 2023年Q1-Q4海外游戏收入占比从27.3%增长到34%。
   - 游戏《PUBG Mobile》、《Brawl Stars》和《Honor Of Kings》在海外市场表现良好。

4. **科技投入，成效显著**
   - 全年研发投入达641亿元，2018年至今累计研发投入超2696亿元。
   - 截至2023年12月，专利申请公开总数超过75000件，专利授权数量超过37000件。
   - 腾讯混元大模型能力位列国内第一梯队，功能持续拓展，内部400+个业务接入混元内测。
   - 已在腾讯会议和腾讯文档中推出AI助手服务。
============ Serving Benchmark Result ============
Successful requests:                     1         
Benchmark duration (s):                  50.09     
Total input tokens:                      5         
Total image and input tokens:            1273      
Total generated tokens:                  440       
Request throughput (req/s):              0.02      
Output token throughput (tok/s):         8.78      
Total Token throughput (tok/s):          8.88      
---------------Time to First Token----------------
Mean TTFT (ms):                          3000.15   
Median TTFT (ms):                        3000.15   
P99 TTFT (ms):                           3000.15   
-----Time per Output Token (excl. 1st token)------
Mean TPOT (ms):                          107.26    
Median TPOT (ms):                        107.26    
P99 TPOT (ms):                           107.26    
---------------Inter-token Latency----------------
Mean ITL (ms):                           107.01    
Median ITL (ms):                         107.32    
P99 ITL (ms):                            114.02    
==================================================
Processing:
  Image : ../accuracy/invoice/Apple-FY24-Q4.png
  Prompt: ../accuracy/invoice/prompt.txt

Namespace(seed=0, batch_size=1, output_len=512, image_path='../accuracy/invoice/Apple-FY24-Q4.png', prompt='请详细描述图像内容', model='/llm/models/Qwen2-VL-72B-Instruct/', base_url=None, host='127.0.0.1', port=8000, endpoint='/v1/chat/completions', served_model_name=None, ignore_eos=False)
image size:  (1435, 1876)
输出结果： 这张图片是苹果公司（Apple Inc.）的简要合并损益表（CONDENSED CONSOLIDATED STATEMENTS OF OPERATIONS），未经审计。表格展示了截至2024年9月28日和2023年9月30日的三个月和十二个月的财务数据。

### 净销售额 (Net sales)
- **产品 (Products)**: 2024年9月28日为$69,958百万，2023年9月30日为$67,184百万。
- **服务 (Services)**: 2024年9月28日为$24,972百万，2023年9月30日为$22,314百万。
- **总净销售额 (Total net sales)**: 2024年9月28日为$94,930百万，2023年9月30日为$89,498百万。

### 销售成本 (Cost of sales)
- **产品 (Products)**: 2024年9月28日为$44,566百万，2023年9月30日为$42,586百万。
- **服务 (Services)**: 2024年9月28日为$6,485百万，2023年9月30日为$6,485百万。
- **总销售成本 (Total cost of sales)**: 2024年9月28日为$51,051百万，2023年9月30日为$49,071百万。

### 毛利润 (Gross margin)
- 2024年9月28日为$43,879百万，2023年9月30日为$40,427百万。

### 营业费用 (Operating expenses)
- **研发费用 (Research and development)**: 2024年9月28日为$7,765百万，2023年9月30日为$7,307百万。
- **销售、一般和管理费用 (Selling, general and administrative)**: 2024
============ Serving Benchmark Result ============
Successful requests:                     1         
Benchmark duration (s):                  64.71     
Total input tokens:                      5         
Total image and input tokens:            3443      
Total generated tokens:                  512       
Request throughput (req/s):              0.02      
Output token throughput (tok/s):         7.91      
Total Token throughput (tok/s):          7.99      
---------------Time to First Token----------------
Mean TTFT (ms):                          9269.53   
Median TTFT (ms):                        9269.53   
P99 TTFT (ms):                           9269.53   
-----Time per Output Token (excl. 1st token)------
Mean TPOT (ms):                          108.49    
Median TPOT (ms):                        108.49    
P99 TPOT (ms):                           108.49    
---------------Inter-token Latency----------------
Mean ITL (ms):                           108.28    
Median ITL (ms):                         108.23    
P99 ITL (ms):                            116.49    
==================================================
Processing:
  Image : ../accuracy/invoice/Tencent-Stock-Price.png
  Prompt: ../accuracy/invoice/prompt.txt

Namespace(seed=0, batch_size=1, output_len=512, image_path='../accuracy/invoice/Tencent-Stock-Price.png', prompt='请详细描述图像内容', model='/llm/models/Qwen2-VL-72B-Instruct/', base_url=None, host='127.0.0.1', port=8000, endpoint='/v1/chat/completions', served_model_name=None, ignore_eos=False)
image size:  (1228, 913)
输出结果： 这张图片显示了腾讯股票在过去一年中的价格走势。以下是图片的详细描述：

1. **标题**：
   - 市场概况 > 腾讯

2. **当前股价**：
   - 58.79 USD

3. **涨跌幅**：
   - +20.41 (53.18%) 过去 1 年

4. **收盘时间**：
   - 4月15日 GMT-4 下午4:38

5. **盘后价**：
   - 58.79 0.00 (0.00%)

6. **时间范围选择**：
   - 1 天 | 5 天 | 1 个月 | 6 个月 | YTD | 1 年 | 5 年 | 最大

7. **图表**：
   - 图表显示了过去一年中腾讯股票的价格走势，以红色线条表示。
   - 图表上有一个标记点，显示在2024年7月15日，价格为49.42 USD。

8. **关键数据**：
   - 开盘：58.57
   - 最高：59.19
   - 最低：58.45
   - 市值：4.07万亿 HKD
   - 市盈率：-
   - 股息收益率：-

9. **其他信息**：
   - 右上角有一个蓝色按钮，写着“+ 关注”。

这张图片提供了腾讯股票在过去一年中的详细价格走势和相关数据。
============ Serving Benchmark Result ============
Successful requests:                     1         
Benchmark duration (s):                  40.86     
Total input tokens:                      5         
Total image and input tokens:            1478      
Total generated tokens:                  349       
Request throughput (req/s):              0.02      
Output token throughput (tok/s):         8.54      
Total Token throughput (tok/s):          8.66      
---------------Time to First Token----------------
Mean TTFT (ms):                          3477.89   
Median TTFT (ms):                        3477.89   
P99 TTFT (ms):                           3477.89   
-----Time per Output Token (excl. 1st token)------
Mean TPOT (ms):                          107.42    
Median TPOT (ms):                        107.42    
P99 TPOT (ms):                           107.42    
---------------Inter-token Latency----------------
Mean ITL (ms):                           107.12    
Median ITL (ms):                         107.21    
P99 ITL (ms):                            114.02    
==================================================
Processing:
  Image : ../accuracy/zto/37_20240903104631_78830622395633.jpg
  Prompt: ../accuracy/zto/prompt.txt

Namespace(seed=0, batch_size=1, output_len=512, image_path='../accuracy/zto/37_20240903104631_78830622395633.jpg', prompt='Please utilize the visual large model to analyze the image and determine the presence of the following elements: 1. Entrance door (Y/N), 2. Package (Y/N). Output the results concatenated by a comma, for example: Y,N.', model='/llm/models/Qwen2-VL-72B-Instruct/', base_url=None, host='127.0.0.1', port=8000, endpoint='/v1/chat/completions', served_model_name=None, ignore_eos=False)
image size:  (1170, 1789)
输出结果： N,Y
============ Serving Benchmark Result ============
Successful requests:                     1         
Benchmark duration (s):                  7.71      
Total input tokens:                      50        
Total image and input tokens:            2759      
Total generated tokens:                  3         
Request throughput (req/s):              0.13      
Output token throughput (tok/s):         0.39      
Total Token throughput (tok/s):          6.88      
---------------Time to First Token----------------
Mean TTFT (ms):                          7467.37   
Median TTFT (ms):                        7467.37   
P99 TTFT (ms):                           7467.37   
-----Time per Output Token (excl. 1st token)------
Mean TPOT (ms):                          120.52    
Median TPOT (ms):                        120.52    
P99 TPOT (ms):                           120.52    
---------------Inter-token Latency----------------
Mean ITL (ms):                           80.34     
Median ITL (ms):                         118.91    
P99 ITL (ms):                            121.99    
==================================================
Processing:
  Image : ../accuracy/zto/40_20240903093021_78830772282673.jpg
  Prompt: ../accuracy/zto/prompt.txt

Namespace(seed=0, batch_size=1, output_len=512, image_path='../accuracy/zto/40_20240903093021_78830772282673.jpg', prompt='Please utilize the visual large model to analyze the image and determine the presence of the following elements: 1. Entrance door (Y/N), 2. Package (Y/N). Output the results concatenated by a comma, for example: Y,N.', model='/llm/models/Qwen2-VL-72B-Instruct/', base_url=None, host='127.0.0.1', port=8000, endpoint='/v1/chat/completions', served_model_name=None, ignore_eos=False)
image size:  (1080, 1440)
输出结果： N,Y
============ Serving Benchmark Result ============
Successful requests:                     1         
Benchmark duration (s):                  5.44      
Total input tokens:                      50        
Total image and input tokens:            2060      
Total generated tokens:                  3         
Request throughput (req/s):              0.18      
Output token throughput (tok/s):         0.55      
Total Token throughput (tok/s):          9.74      
---------------Time to First Token----------------
Mean TTFT (ms):                          5205.99   
Median TTFT (ms):                        5205.99   
P99 TTFT (ms):                           5205.99   
-----Time per Output Token (excl. 1st token)------
Mean TPOT (ms):                          117.94    
Median TPOT (ms):                        117.94    
P99 TPOT (ms):                           117.94    
---------------Inter-token Latency----------------
Mean ITL (ms):                           78.62     
Median ITL (ms):                         114.21    
P99 ITL (ms):                            121.45    
==================================================
Processing:
  Image : ../accuracy/zto/40_20240903102200_78830779335152.jpg
  Prompt: ../accuracy/zto/prompt.txt

Namespace(seed=0, batch_size=1, output_len=512, image_path='../accuracy/zto/40_20240903102200_78830779335152.jpg', prompt='Please utilize the visual large model to analyze the image and determine the presence of the following elements: 1. Entrance door (Y/N), 2. Package (Y/N). Output the results concatenated by a comma, for example: Y,N.', model='/llm/models/Qwen2-VL-72B-Instruct/', base_url=None, host='127.0.0.1', port=8000, endpoint='/v1/chat/completions', served_model_name=None, ignore_eos=False)
image size:  (1080, 1440)
输出结果： N,Y
============ Serving Benchmark Result ============
Successful requests:                     1         
Benchmark duration (s):                  5.47      
Total input tokens:                      50        
Total image and input tokens:            2060      
Total generated tokens:                  3         
Request throughput (req/s):              0.18      
Output token throughput (tok/s):         0.55      
Total Token throughput (tok/s):          9.69      
---------------Time to First Token----------------
Mean TTFT (ms):                          5236.10   
Median TTFT (ms):                        5236.10   
P99 TTFT (ms):                           5236.10   
-----Time per Output Token (excl. 1st token)------
Mean TPOT (ms):                          116.63    
Median TPOT (ms):                        116.63    
P99 TPOT (ms):                           116.63    
---------------Inter-token Latency----------------
Mean ITL (ms):                           77.75     
Median ITL (ms):                         116.49    
P99 ITL (ms):                            116.71    
==================================================
Processing:
  Image : ../accuracy/zto/37_20240902175912_78830632899074.jpg
  Prompt: ../accuracy/zto/prompt.txt

Namespace(seed=0, batch_size=1, output_len=512, image_path='../accuracy/zto/37_20240902175912_78830632899074.jpg', prompt='Please utilize the visual large model to analyze the image and determine the presence of the following elements: 1. Entrance door (Y/N), 2. Package (Y/N). Output the results concatenated by a comma, for example: Y,N.', model='/llm/models/Qwen2-VL-72B-Instruct/', base_url=None, host='127.0.0.1', port=8000, endpoint='/v1/chat/completions', served_model_name=None, ignore_eos=False)
image size:  (768, 1024)
输出结果： N,Y
============ Serving Benchmark Result ============
Successful requests:                     1         
Benchmark duration (s):                  2.66      
Total input tokens:                      50        
Total image and input tokens:            1070      
Total generated tokens:                  3         
Request throughput (req/s):              0.38      
Output token throughput (tok/s):         1.13      
Total Token throughput (tok/s):          19.93     
---------------Time to First Token----------------
Mean TTFT (ms):                          2421.51   
Median TTFT (ms):                        2421.51   
P99 TTFT (ms):                           2421.51   
-----Time per Output Token (excl. 1st token)------
Mean TPOT (ms):                          118.93    
Median TPOT (ms):                        118.93    
P99 TPOT (ms):                           118.93    
---------------Inter-token Latency----------------
Mean ITL (ms):                           79.28     
Median ITL (ms):                         116.50    
P99 ITL (ms):                            121.18    
==================================================
Processing:
  Image : ../accuracy/vl_debug/torch_evaluation_issue-merged.png
  Prompt: ../accuracy/vl_debug/prompt.txt

Namespace(seed=0, batch_size=1, output_len=512, image_path='../accuracy/vl_debug/torch_evaluation_issue-merged.png', prompt='目标代码详见图上半部分 snapshot-code，测试报错信息详见图下半部分 snapshot-feedback. 请尝试定位代码遇到的问题，并给出分析，如果可能，给出解决方案.', model='/llm/models/Qwen2-VL-72B-Instruct/', base_url=None, host='127.0.0.1', port=8000, endpoint='/v1/chat/completions', served_model_name=None, ignore_eos=False)
image size:  (846, 1084)
输出结果： 从错误信息来看，问题出在`self.fc3(x)`这一行。具体来说，是由于`fc3`的输入和权重形状不匹配导致的。

### 错误分析

1. **输入形状**：`x`的形状是`(1, 768)`。
2. **权重形状**：`fc3`的权重形状是`(256, 768)`。

当使用`torch.nn.Linear`时，输入的形状应该是`(batch_size, input_features)`，而权重的形状是`(output_features, input_features)`。因此，输入的特征数应该与权重的列数相匹配。

### 解决方案

根据`MLP`类的定义，`fc3`的输入维度应该是`hidden_dim`（默认为256），而不是`input_dim`（768）。因此，需要确保`x`在进入`fc3`之前已经被正确地转换为256维。

### 修改代码

你可以通过添加一个额外的全连接层来将输入从768维转换为256维，然后再将其传递给`fc3`。以下是修改后的代码：

```python
class MLP(torch.nn.Module):
    def __init__(self, input_dim, output_dim, hidden_dim=256):
        super(MLP, self).__init__()
        self.fc1 = torch.nn.Linear(input_dim, hidden_dim)
        self.fc2 = torch.nn.Linear(hidden_dim, hidden_dim*2)
        self.fc3 = torch.nn.Linear(hidden_dim*2, hidden_dim)  # 新增一层，将维度转换为256
        self.fc4 = torch.nn.Linear(hidden_dim, output_dim)  # fc3改为fc4
        self.relu = torch.nn.ReLU()

    def forward(self, x):
        x = self.fc1(x)
        x = self.relu(x)
        x = self.fc2(x)
        x = self.relu(x)
        x = self.fc3(x)  # 新增一层
        x = self.relu(x)
        x = self.fc4(x)  # fc3改为fc4
        return x

net = MLP(768, 768)
net.eval()
with torch.inference_mode():
    x = torch.randn(1, 768)
    y = net(x)
    print(y.shape)  # 应该打印torch.Size([1,
============ Serving Benchmark Result ============
Successful requests:                     1         
Benchmark duration (s):                  58.25     
Total input tokens:                      38        
Total image and input tokens:            1229      
Total generated tokens:                  512       
Request throughput (req/s):              0.02      
Output token throughput (tok/s):         8.79      
Total Token throughput (tok/s):          9.44      
---------------Time to First Token----------------
Mean TTFT (ms):                          2884.07   
Median TTFT (ms):                        2884.07   
P99 TTFT (ms):                           2884.07   
-----Time per Output Token (excl. 1st token)------
Mean TPOT (ms):                          108.36    
Median TPOT (ms):                        108.36    
P99 TPOT (ms):                           108.36    
---------------Inter-token Latency----------------
Mean ITL (ms):                           108.14    
Median ITL (ms):                         108.09    
P99 ITL (ms):                            115.59    
==================================================
Processing:
  Image : ../accuracy/vl_debug/numpy_computation_issue-merged.png
  Prompt: ../accuracy/vl_debug/prompt.txt

Namespace(seed=0, batch_size=1, output_len=512, image_path='../accuracy/vl_debug/numpy_computation_issue-merged.png', prompt='目标代码详见图上半部分 snapshot-code，测试报错信息详见图下半部分 snapshot-feedback. 请尝试定位代码遇到的问题，并给出分析，如果可能，给出解决方案.', model='/llm/models/Qwen2-VL-72B-Instruct/', base_url=None, host='127.0.0.1', port=8000, endpoint='/v1/chat/completions', served_model_name=None, ignore_eos=False)
image size:  (681, 630)
输出结果： 从提供的代码和错误信息来看，问题出在除法操作 `result = val / div` 上。具体来说，当 `div` 的值为零时，会导致除以零的错误。

### 错误分析

1. **变量初始化**：
   ```python
   val = np.array([[1, 2, 3]]*10)
   parts = val.copy() + 15
   another_clone = parts.copy()
   div = np.sum(another_clone - parts)
   ```

2. **除法操作**：
   ```python
   result = val / div
   ```

3. **错误信息**：
   ```
   RuntimeWarning: divide by zero encountered in divide
   ```

### 解决方案

为了避免除以零的错误，可以在执行除法操作之前检查 `div` 是否为零。如果是零，则可以设置一个默认值或者直接返回 `None`。

以下是修改后的代码：

```python
import numpy as np

def mydemo():
    """
    This function demonstrates how mapreduce
    can be applied to np array with auto-broadcast.
    """
    try:
        # Attempt to init some variables
        val = np.array([[1, 2, 3]]*10)
        print(val.shape)
        parts = val.copy() + 15
        another_clone = parts.copy()
        div = np.sum(another_clone - parts)

        # Check if div is zero before division
        if div == 0:
            print("Warning: Division by zero detected.")
            return None

        result = val / div
    except ZeroDivisionError as e:
        print(f"Error: {e}")
        return None

    return result

mydemo()
```

### 修改说明

1. 在执行除法操作之前，添加了对 `div` 是否为零的检查。
2. 如果 `div` 为零，打印警告信息并返回 `None`。

这样可以避免除以零的错误，并且在 `div` 为零的情况下提供明确的反馈。
============ Serving Benchmark Result ============
Successful requests:                     1         
Benchmark duration (s):                  47.91     
Total input tokens:                      38        
Total image and input tokens:            587       
Total generated tokens:                  436       
Request throughput (req/s):              0.02      
Output token throughput (tok/s):         9.10      
Total Token throughput (tok/s):          9.89      
---------------Time to First Token----------------
Mean TTFT (ms):                          1501.35   
Median TTFT (ms):                        1501.35   
P99 TTFT (ms):                           1501.35   
-----Time per Output Token (excl. 1st token)------
Mean TPOT (ms):                          106.69    
Median TPOT (ms):                        106.69    
P99 TPOT (ms):                           106.69    
---------------Inter-token Latency----------------
Mean ITL (ms):                           106.44    
Median ITL (ms):                         106.59    
P99 ITL (ms):                            113.42    
==================================================
Processing:
  Image : ../accuracy/vl_debug/llm_inference_issue-merged.png
  Prompt: ../accuracy/vl_debug/prompt.txt

Namespace(seed=0, batch_size=1, output_len=512, image_path='../accuracy/vl_debug/llm_inference_issue-merged.png', prompt='目标代码详见图上半部分 snapshot-code，测试报错信息详见图下半部分 snapshot-feedback. 请尝试定位代码遇到的问题，并给出分析，如果可能，给出解决方案.', model='/llm/models/Qwen2-VL-72B-Instruct/', base_url=None, host='127.0.0.1', port=8000, endpoint='/v1/chat/completions', served_model_name=None, ignore_eos=False)
image size:  (720, 741)
输出结果： 从错误信息来看，问题出在 `tokenizer` 对象没有被正确初始化。具体来说，`tokenizer` 被设置为 `None`，然后在后续的代码中尝试调用 `tokenizer` 的方法，导致了 `TypeError: 'NoneType' object is not callable` 错误。

### 分析

1. **tokenizer 初始化问题**：
   - 在代码中，`tokenizer` 被初始化为 `None`。
   - 后续的代码中，尝试使用 `tokenizer` 进行文本编码和解码操作。

2. **错误堆栈**：
   - 错误发生在 `inputs = tokenizer(text, return_tensors="pt")` 这一行。
   - 由于 `tokenizer` 是 `None`，所以无法调用其方法。

### 解决方案

1. **正确初始化 tokenizer**：
   - 确保在使用 `tokenizer` 之前，它已经被正确地从预训练模型加载。
   - 修改代码如下：

```python
from transformers import GenerationConfig, AutoTokenizer
from ipex_llm.transformers import AutoModelForCausalLM
import os
import torch

root_weight = "/weights/share"
model_name = os.path.join(root_weight, "deepseek-moe-16b-chat")

# 正确初始化 tokenizer
tokenizer = AutoTokenizer.from_pretrained(model_name)

model = AutoModelForCausalLM.from_pretrained(
    model_name,
    trust_remote_code=True,
    load_in_4bit=True).eval()

model.generation_config = GenerationConfig.from_pretrained(model_name)
model.generation_config.pad_token_id = model.generation_config.eos_token_id

text = "An attention function can be described as mapping a query and a set of key-value pairs"
inputs = tokenizer(text, return_tensors="pt")
with torch.inference_mode():
    outputs = model.generate(**inputs, max_new_tokens=128)

result = tokenizer.decode(outputs[0], skip_special_tokens=True)
print(result)
```

2. **检查预训练模型路径**：
   - 确保 `model_name` 指向的路径是正确的，并且包含有效的预训练模型文件。

3. **检查环境配置**：
   - 确保所有必要的库（如 `transformers` 和 `ipex_llm`）都已经正确安装。

通过以上修改，应该可以解决 `tokenizer` 初始化问题，从而避免 `TypeError`
============ Serving Benchmark Result ============
Successful requests:                     1         
Benchmark duration (s):                  57.12     
Total input tokens:                      38        
Total image and input tokens:            735       
Total generated tokens:                  512       
Request throughput (req/s):              0.02      
Output token throughput (tok/s):         8.96      
Total Token throughput (tok/s):          9.63      
---------------Time to First Token----------------
Mean TTFT (ms):                          1745.64   
Median TTFT (ms):                        1745.64   
P99 TTFT (ms):                           1745.64   
-----Time per Output Token (excl. 1st token)------
Mean TPOT (ms):                          108.35    
Median TPOT (ms):                        108.35    
P99 TPOT (ms):                           108.35    
---------------Inter-token Latency----------------
Mean ITL (ms):                           108.14    
Median ITL (ms):                         108.10    
P99 ITL (ms):                            115.65    
==================================================
Processing:
  Image : ../accuracy/edu/rope/rope_image.jpg
  Prompt: ../accuracy/edu/rope/rope_prompt.txt

Namespace(seed=0, batch_size=1, output_len=512, image_path='../accuracy/edu/rope/rope_image.jpg', prompt='How many ropes can you see in this picture?', model='/llm/models/Qwen2-VL-72B-Instruct/', base_url=None, host='127.0.0.1', port=8000, endpoint='/v1/chat/completions', served_model_name=None, ignore_eos=False)
image size:  (401, 302)
输出结果： In the picture, I can see one rope that is intricately intertwined with itself.
============ Serving Benchmark Result ============
Successful requests:                     1         
Benchmark duration (s):                  2.62      
Total input tokens:                      10        
Total image and input tokens:            185       
Total generated tokens:                  18        
Request throughput (req/s):              0.38      
Output token throughput (tok/s):         6.88      
Total Token throughput (tok/s):          10.71     
---------------Time to First Token----------------
Mean TTFT (ms):                          771.03    
Median TTFT (ms):                        771.03    
P99 TTFT (ms):                           771.03    
-----Time per Output Token (excl. 1st token)------
Mean TPOT (ms):                          108.46    
Median TPOT (ms):                        108.46    
P99 TPOT (ms):                           108.46    
---------------Inter-token Latency----------------
Mean ITL (ms):                           102.44    
Median ITL (ms):                         107.92    
P99 ITL (ms):                            112.19    
==================================================
Processing:
  Image : ../accuracy/edu/cake/cake_image.jpg
  Prompt: ../accuracy/edu/cake/cake_prompt.txt

Namespace(seed=0, batch_size=1, output_len=512, image_path='../accuracy/edu/cake/cake_image.jpg', prompt='Emily celebrated her birthday on Thursday, and her sister Liepa 8 days earlier. Which weekday was that? Option:[ \\"Wednesday\\", \\"Thursday\\", \\"Friday\\", \\"Tuesday\\", \\"Sunday\\" ]\r \r', model='/llm/models/Qwen2-VL-72B-Instruct/', base_url=None, host='127.0.0.1', port=8000, endpoint='/v1/chat/completions', served_model_name=None, ignore_eos=False)
image size:  (422, 282)
输出结果： If Emily celebrated her birthday on Thursday and her sister Liepa celebrated hers 8 days earlier, we can count back from Thursday to find the day of Liepa's birthday.

- 1 day before Thursday is Wednesday.
- 2 days before Thursday is Tuesday.
- 3 days before Thursday is Monday.
- 4 days before Thursday is Sunday.
- 5 days before Thursday is Saturday.
- 6 days before Thursday is Friday.
- 7 days before Thursday is Thursday (the previous week).
- 8 days before Thursday is Wednesday (the previous week).

So, Liepa's birthday was on Wednesday.
============ Serving Benchmark Result ============
Successful requests:                     1         
Benchmark duration (s):                  14.42     
Total input tokens:                      43        
Total image and input tokens:            214       
Total generated tokens:                  126       
Request throughput (req/s):              0.07      
Output token throughput (tok/s):         8.74      
Total Token throughput (tok/s):          11.72     
---------------Time to First Token----------------
Mean TTFT (ms):                          818.01    
Median TTFT (ms):                        818.01    
P99 TTFT (ms):                           818.01    
-----Time per Output Token (excl. 1st token)------
Mean TPOT (ms):                          108.81    
Median TPOT (ms):                        108.81    
P99 TPOT (ms):                           108.81    
---------------Inter-token Latency----------------
Mean ITL (ms):                           107.94    
Median ITL (ms):                         108.39    
P99 ITL (ms):                            118.25    
==================================================
Processing:
  Image : ../accuracy/edu/math/math_image.jpg
  Prompt: ../accuracy/edu/math/math_prompt.txt

Namespace(seed=0, batch_size=1, output_len=512, image_path='../accuracy/edu/math/math_image.jpg', prompt='Which number do you have to write in the last daisy?', model='/llm/models/Qwen2-VL-72B-Instruct/', base_url=None, host='127.0.0.1', port=8000, endpoint='/v1/chat/completions', served_model_name=None, ignore_eos=False)
image size:  (1314, 276)
输出结果： To find the number that needs to be written in the last daisy, we need to follow the sequence of operations starting from the first daisy.

Starting with 48:
1. Subtract 20: \( 48 - 20 = 28 \)
2. Add 9: \( 28 + 9 = 37 \)
3. Subtract 6: \( 37 - 6 = 31 \)
4. Add 30: \( 31 + 30 = 61 \)

So, the number that needs to be written in the last daisy is 61.
============ Serving Benchmark Result ============
Successful requests:                     1         
Benchmark duration (s):                  15.90     
Total input tokens:                      13        
Total image and input tokens:            504       
Total generated tokens:                  136       
Request throughput (req/s):              0.06      
Output token throughput (tok/s):         8.56      
Total Token throughput (tok/s):          9.37      
---------------Time to First Token----------------
Mean TTFT (ms):                          1340.87   
Median TTFT (ms):                        1340.87   
P99 TTFT (ms):                           1340.87   
-----Time per Output Token (excl. 1st token)------
Mean TPOT (ms):                          107.82    
Median TPOT (ms):                        107.82    
P99 TPOT (ms):                           107.82    
---------------Inter-token Latency----------------
Mean ITL (ms):                           107.02    
Median ITL (ms):                         107.71    
P99 ITL (ms):                            113.04    
==================================================
